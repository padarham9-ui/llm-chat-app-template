<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cloudflare AI Chat</title>

<!-- Tailored ChatGPT-like CSS -->
<style>
:root{
  --bg:#212121;
  --assistant:#2f2f2f;
  --user:#3b3b3b;
  --input:#2a2a2a;
  --border:#3a3a3a;
  --text:#ececec;
  --sub:#9ca3af;
  --accent:#10a37f;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
}

.chat-wrapper{
  display:flex;
  flex-direction:column;
  width:100%;
  max-width:900px;
  margin:auto;
  height:100vh;
}

header{
  padding:16px;
  text-align:center;
  border-bottom:1px solid var(--border);
  font-weight:600;
  font-size:18px;
}

.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.message{
  display:flex;
  max-width:100%;
}

.assistant{justify-content:flex-start;}
.assistant .message-content{
  background: var(--assistant);
  border-radius:18px 18px 18px 4px;
  padding:14px 16px;
  line-height:1.5;
  white-space:pre-wrap;
  word-break:break-word;
  box-shadow:0 1px 3px rgba(0,0,0,0.2);
}

.user{justify-content:flex-end;}
.user .message-content{
  background: var(--user);
  border-radius:18px 18px 4px 18px;
  padding:14px 16px;
  line-height:1.5;
  white-space:pre-wrap;
  word-break:break-word;
  box-shadow:0 1px 3px rgba(0,0,0,0.2);
}

.typing{
  font-size:14px;
  color:var(--sub);
  padding-left:6px;
}

.input-area{
  border-top:1px solid var(--border);
  padding:16px;
  background:var(--bg);
}

.input-box{
  display:flex;
  align-items:flex-end;
  background:var(--input);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
}

textarea{
  flex:1;
  background:transparent;
  border:none;
  outline:none;
  resize:none;
  color:var(--text);
  font-size:15px;
  max-height:200px;
}

button{
  background:var(--accent);
  border:none;
  color:white;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  margin-left:8px;
  transition:.2s;
}
button:hover{opacity:.85;}

.copy-btn{
  position:absolute;
  top:8px;
  right:8px;
  padding:4px 8px;
  font-size:12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#10a37f;
  color:#fff;
}

footer{
  text-align:center;
  font-size:12px;
  color:var(--sub);
  padding:8px;
}
</style>

<!-- Marked.js CDN for Markdown support -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>
<body>

<div class="chat-wrapper">

<header>Cloudflare AI Chat</header>

<div id="chat-messages" class="chat-messages">
  <div class="message assistant">
    <div class="message-content">Ø³Ù„Ø§Ù… Ù¾Ø±Ù‡Ø§Ù… ðŸ˜Ž<br>UI Ø´Ø¨ÛŒÙ‡ ChatGPT Ø´Ø¯. Ø¨Ú¯Ùˆ Ú†ÛŒ Ø¨Ø³Ø§Ø²ÛŒÙ…ØŸ</div>
  </div>
</div>

<div class="typing" id="typing-indicator" style="display:none;">AI is thinking...</div>

<div class="input-area">
  <div class="input-box">
    <textarea id="user-input" placeholder="Message AI..." rows="1"></textarea>
    <button id="send-button">â†‘</button>
  </div>
</div>

<footer>Powered by Cloudflare Workers AI</footer>

</div>

<script>
// DOM
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");
const typingIndicator = document.getElementById("typing-indicator");

let chatHistory = [
  { role:"assistant", content:"Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… ØªØ§ Ú©Ù…Ú©Øª Ú©Ù†Ù…." }
];
let isProcessing=false;

// Auto-resize textarea
userInput.addEventListener("input", function(){
  this.style.height="auto";
  this.style.height=this.scrollHeight+"px";
});

// Enter to send
userInput.addEventListener("keydown", function(e){
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

sendButton.addEventListener("click", sendMessage);

async function sendMessage(){
  const message = userInput.value.trim();
  if(!message || isProcessing) return;

  isProcessing=true;
  userInput.disabled=true;
  sendButton.disabled=true;

  addMessageToChat("user", message);

  userInput.value="";
  userInput.style.height="auto";

  chatHistory.push({role:"user", content:message});
  typingIndicator.style.display="block";

  try{
    const assistantMessageEl = document.createElement("div");
    assistantMessageEl.className="message assistant";
    const contentEl = document.createElement("div");
    contentEl.className="message-content";
    assistantMessageEl.appendChild(contentEl);
    chatMessages.appendChild(assistantMessageEl);
    chatMessages.scrollTop=chatMessages.scrollHeight;

    // Fetch API
    const response = await fetch("/api/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:chatHistory})
    });
    if(!response.ok || !response.body) throw new Error("API Error");

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer="";
    let responseText="";

    while(true){
      const {done,value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value,{stream:true});
      const parts = buffer.split("\n\n");
      buffer = parts.pop();

      for(const part of parts){
        const lines = part.split("\n");
        for(const line of lines){
          if(!line.startsWith("data:")) continue;
          const data=line.replace("data:","").trim();
          if(data==="[DONE]") break;
          try{
            const json=JSON.parse(data);
            let content="";
            if(json.response) content=json.response;
            else if(json.choices?.[0]?.delta?.content) content=json.choices[0].delta.content;
            if(content){
              responseText += content;
              renderMarkdown(contentEl, responseText);
            }
          }catch(e){console.error(e);}
        }
      }
    }

    if(responseText) chatHistory.push({role:"assistant", content:responseText});
  }catch(err){
    console.error(err);
    addMessageToChat("assistant","âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯!");
  }finally{
    isProcessing=false;
    userInput.disabled=false;
    sendButton.disabled=false;
    userInput.focus();
    typingIndicator.style.display="none";
  }
}

// Add message
function addMessageToChat(role, content){
  const messageEl=document.createElement("div");
  messageEl.className=`message ${role}`;
  const contentEl=document.createElement("div");
  contentEl.className="message-content";
  renderMarkdown(contentEl, content);
  messageEl.appendChild(contentEl);
  chatMessages.appendChild(messageEl);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

// Markdown + Copy button
function renderMarkdown(element,text){
  if(typeof marked!=="undefined"){
    element.innerHTML=marked.parse(text);
  }else element.textContent=text;

  // Add copy button to code blocks
  const blocks=element.querySelectorAll("pre");
  blocks.forEach(block=>{
    if(block.querySelector(".copy-btn")) return;

    const button=document.createElement("button");
    button.className="copy-btn";
    button.innerText="Copy";
    button.onclick=()=>{
      const code=block.querySelector("code").innerText;
      navigator.clipboard.writeText(code);
      button.innerText="Copied!";
      setTimeout(()=>button.innerText="Copy",1500);
    };
    block.style.position="relative";
    block.appendChild(button);
  });
  chatMessages.scrollTop=chatMessages.scrollHeight;
}
</script>

</body>
</html>
